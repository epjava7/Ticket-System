<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket View</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
    <div id="main" class="container">
        <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
            <h1>Ticket Dashboard</h1>
            <div>
                <a href="dashboard.html" class="btn btn-secondary">Back</a>
                <button id="logoutButton" class="btn btn-danger">Logout</button>
            </div>
        </div>

        <div id="ticketInfo" class="mt-5">
    </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    $(document).ready(() => {

        let params = new URLSearchParams(window.location.search)
        if (!params.has('id')) {
            window.location.replace('dashboard.html')
            return
        }
        let ticketId = params.get('id')

        let token = null;
        $.ajax({
            url: 'http://localhost:8081/api/auth/refresh',
            type: 'POST',
            xhrFields: { withCredentials: true },
            success: (res) => {
                token = res.token
                console.log("Token refreshed")
                renderTicket()
            },
            error: () => {
                window.location.replace('login.html')
                console.log("Session Expired")
            }
        })
        
        function renderTicket() {
            $.ajax({
                url: `http://localhost:8081/api/tickets/${ticketId}`,
                type: 'GET',
                headers: { Authorization: `Bearer ${token}` },
                success: (ticket) => {

                    let ticketInfoHtml = `
                        <h1>${ticket.title}</h1>
                        <p><strong>Description:</strong> ${ticket.description}</p>
                        <p><strong>Priority:</strong> ${ticket.priority}</p>
                        <p><strong>Status:</strong> ${ticket.status}</p>
                        <p><strong>Created By:</strong> ${ticket.createdByName}</p>
                        <p><strong>Created At:</strong> ${new Date(ticket.creationDate).toLocaleString()}</p>
                        `

                    if (ticket.fileAttachmentPaths && ticket.fileAttachmentPaths.length > 0) {
                        ticketInfoHtml += `<p class="mt-3"><strong>Attachments:</strong></p><ul class="list-unstyled">`
                        ticket.fileAttachmentPaths.forEach((filePath) => {
                            const lastSlash = filePath.lastIndexOf('/')
                            const lastBackslash = filePath.lastIndexOf('\\')
                            const separatorIndex = Math.max(lastSlash, lastBackslash)
                            let fileName = filePath.substring(separatorIndex + 1)
                            
                            ticketInfoHtml += `
                              <li class="mb-2">
                                <button class="btn btn-sm btn-primary download-file-btn ms-2" data-file="${fileName}">Download</button>
                                <span>${fileName}</span>
                              </li>`
                    })
                        ticketInfoHtml += '</ul>';
                    }
                    

                    $('#ticketInfo').html(ticketInfoHtml)

                    if (ticket.fileAttachmentPaths) {
                        $('.download-file-btn').on('click', function() {
                            let fileName = $(this).data('file')
                            $.ajax({
                                url: `http://localhost:8081/api/tickets/download/${ticketId}/${encodeURIComponent(fileName)}`,
                                type: 'GET',
                                headers: { 'Authorization': `Bearer ${token}` },
                                xhrFields: {
                                    responseType: 'blob' 
                                },
                                success: function(blob) {
                                    const url = URL.createObjectURL(blob)
                                    const a = document.createElement('a')
                                    a.href = url
                                    a.download = fileName
                                    document.body.appendChild(a)
                                    a.click()
                                    document.body.removeChild(a)
                                    URL.revokeObjectURL(url)
                                },
                                error: function(e) {
                                    console.error(e)
                                }
                            })
                        })
                    }

                }
            })
        }
    })
</script>
</html>